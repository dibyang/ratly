syntax = "proto3";
option java_package = "net.xdob.ratly.proto.jdbc";
option java_multiple_files = true;
option java_generate_equals_and_hash = true;

package jdbc;


import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";
import "google/protobuf/any.proto";

import "Base.proto";

message SqlEx {
  string message = 1;           // 异常消息
  string sql_state = 2;         // SQL状态码
  int32 error_code = 3;         // 供应商特定的错误代码
  repeated SqlEx causes = 4;  // 原因异常链（嵌套异常）
}


enum ConnRequestType{
  openSession = 0;
  closeSession = 1;

  databaseMeta = 8;

  commit = 10;
  rollback = 11;
  savepoint = 12;
  releaseSavepoint = 13;
  rollbackSavepoint = 14;

  nativeSQL = 20;
  getWarnings = 21;
  clearWarnings = 22;
  setAutoCommit = 23;
  getAutoCommit = 24;
  setTransactionIsolation = 25;
  getTransactionIsolation = 26;

}

enum SqlRequestType{
  query = 0;
  update = 1;

  parameterMeta = 10;
  resultSetMetaData = 11;
}


message SavepointProto{
  int32 id = 1;
  string name = 2;
}

message OpenSessionProto{
  string user = 1;
  string password = 2;
}

message DatabaseMetaRequestProto{
  string method = 1;
  repeated string parametersTypes = 2;
  repeated base.ValueProto args = 3;
}

message ConnRequestProto{
  ConnRequestType type = 1;
  SavepointProto savepoint = 3;
  oneof request {
    string sql = 4;
    bool autoCommit = 5;
    int32 transactionIsolation = 6;
  }

  DatabaseMetaRequestProto databaseMetaRequest = 10;
}

message ParameterProto{
  int32 index = 1;
  base.ValueProto value = 2;
}

message ParametersProto{
  repeated ParameterProto param = 1;
}

enum StmtType{
  statement = 0;
  prepared = 1;
  callable = 2;
}

message SqlRequestProto{
  SqlRequestType type = 1;
  string sql = 3;
  ParametersProto params = 4;
  repeated string batchSql = 5;
  repeated ParametersProto batchParams = 6;
  optional int32 fetch_direction = 7;
  optional int32 fetch_size = 8;
  StmtType stmt_type = 9;
  // 分页参数
  int32 start = 20;
  optional int32 limit = 21;
}

message HeartbeatProto{
}

// JDBC 请求消息
message JdbcRequestProto {
  string db = 1;
  int32 timeout_seconds = 4;  // 执行超时时间
  oneof session_request {
    OpenSessionProto openSession = 10;
    string sessionId = 11;
  }
  oneof request {
    HeartbeatProto heartbeat = 16;
    ConnRequestProto connRequest = 17;
    SqlRequestProto sqlRequest = 18;
  }
}

message ResultSetProto {
  message ColumnMetaProto {
    string name = 1;
    int32 jdbc_type = 2;  // java.sql.Types 值
    string type_name = 3;
    int32 precision = 4;
    int32 scale = 5;
    string label = 6;
  }

  message RowProto {
    repeated base.ValueProto values = 1;
  }

  repeated ColumnMetaProto columns = 1;
  repeated RowProto rows = 2;
  // 分页参数
  int32 start = 10;
  int32 limit = 11;
  int32 total = 12;
}

message UpdateCounts{
  repeated int64 update_count = 1;
}

message ConnectionResponse{
  string sql = 1;
  bool autoCommit = 2;
  int32 transactionIsolation = 3;
  SqlEx SQLWarning = 4;
}

// JDBC 响应消息
message JdbcResponseProto {
  string db = 1;
  string session_id = 4;
  oneof result {
    int64 update_count = 11;  // 更新操作影响的行数
    UpdateCounts update_counts = 12;
    ResultSetProto result_set = 13; // 查询结果集
    ParameterMetaProto parameter_meta = 14; // 参数元数据
    SavepointProto savepoint = 15;
    ConnectionResponse connection = 16;
  }

  bool success = 20;
  SqlEx ex = 21;
}

message ParameterMetaProto {
  repeated Parameter parameters = 1;
  message Parameter{
    int32 nullable = 1;
    int32 precision = 2;
    int32 scale = 3;
    int32 parameterMode = 4;
    int32 parameterType = 5;
    string parameterTypeName =  10;
    string parameterClassName = 11;
  }
}


